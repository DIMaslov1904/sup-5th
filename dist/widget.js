const y={UMI:"admin/content/sitetree/",EzPro:"ezpro/",Bitrix:"bitrix/admin/#authorize",ABO:"login.php",MODX:"manager/",AdminLTE:"admin/",Joomla:"administrator/"},v=(e,n)=>{switch(n){case"Нет":case"":return"#";case"Своя":case"WordPress":return`https://${e}`;case"Tilda":return"https://tilda.ru/login/";default:return`/${y[n]}`}},p=(e,n={})=>{if(!e)return 0;let s=Math.trunc(e);return n.min!==void 0&&(s=Math.max(s,n.min)),n.max!==void 0&&(s=Math.min(s,n.max)),s};let d=null,t=null,i=null,h=!1;const w="projectsState",f=e=>{let n=e==="Своя"?"cms":e==="Нет"?"hosting":e.toLowerCase();return chrome.runtime.getURL(`/assets/icons/${n}.svg`)},g=async()=>{try{const e=await chrome.storage.local.get([w]);return e[w]!==void 0?JSON.parse(e[w]):null}catch(e){return console.error("Ошибка при получении из хранилища:",e),null}},x=async e=>{try{await chrome.storage.local.set({[w]:JSON.stringify(e)})}catch(n){console.error("Ошибка при сохранении в хранилище:",n)}},C=async()=>{var n;if(d=await g(),!d)return;let e;t!=null&&t.widgetPosition&&(t.widgetPosition.x||(n=t.widgetPosition)!=null&&n.y)&&(e=t.widgetPosition),d.projects=d.projects.map(s=>s.url===(t==null?void 0:t.url)?{...s,widgetPosition:e}:s),await x(d)},b=async()=>{if(!(t!=null&&t.cms))return;const e=async()=>{if(!document.querySelector("[name=USER_LOGIN]"))return;const n=document.querySelector("[name=USER_LOGIN]"),s=document.querySelector("[name=USER_PASSWORD]"),o=document.querySelector("[name=USER_REMEMBER]"),a=document.querySelector("[name=Login]");n.value=(t==null?void 0:t.login)||"",s.value=(t==null?void 0:t.password)||"",o.checked=!0,a.click()};switch(t==null?void 0:t.cms){case"Bitrix":await e();break}sessionStorage.removeItem("login")},M=async e=>{if(!(t!=null&&t.cms))return window.open(t==null?void 0:t.urlAdmin,e);const n=async()=>{const o="/admin/content/sitetree/",a="/admin/users/login_do/";try{return await fetch(o,{method:"HEAD",credentials:"include",redirect:"error"}),window.open(o,e)}catch{}const l=new FormData;Object.entries({login:t==null?void 0:t.login,password:t==null?void 0:t.password,ilang:"ru","save-auth-token":1}).forEach(([u,c])=>l.append(u,(c==null?void 0:c.toString())||"")),await fetch(a,{method:"POST",body:l,credentials:"include"}),window.open(o,e)},s=async()=>{const o="/bitrix/admin/#authorize";sessionStorage.setItem("login","1"),window.open(o,e)};switch(t==null?void 0:t.cms){case"UMI":return await n();case"Bitrix":return await s();default:window.open(v(t.urlAdmin,t.cms),e)}},S=()=>{!t||!window.location.href.includes(t==null?void 0:t.urlAdmin)||(h=!0,sessionStorage.getItem("login")&&b())},E=async()=>{if(d=await g(),!d)return;const e=new URL(window.location.href).hostname;t=d.projects.find(n=>n.url?n.subdomain?e.includes(n.url):e===n.url:!1)||null,t&&(S(),L())},L=async()=>{const e=document.createElement("link");e.href=chrome.runtime.getURL("widget.css"),e.rel="stylesheet",document.head.appendChild(e),i=document.createElement("div"),i.className="sup-5th-widget";const n=document.createElement("button");if(n.className="sup-5th-btn sup-5th-menu",n.title="Нажмите для открытия / Зажмите для переноса",n.style=`background-image: url(${f((t==null?void 0:t.cms)||"cms")})`,n.addEventListener("click",()=>{if(!i)return;window.getComputedStyle(i).getPropertyValue("flex-direction")==="row"&&!(i!=null&&i.classList.contains("open"))?i.style.setProperty("--translate",`translate(min(max(calc(var(--x) + ${(i.childElementCount-1)*68}px), calc((100dvw - var(--width) - var(--offset)) * -1)), 0dvw), min(max(var(--y), calc((100dvh - var(--height) - var(--offset)) * -1)), 0dvh))`):i.style.setProperty("--translate","translate(min(max(var(--x), calc((100dvw - var(--width) - var(--offset)) * -1)), 0dvw), min(max(var(--y), calc((100dvh - var(--height) - var(--offset)) * -1)), 0dvh))"),i==null||i.classList.toggle("open")}),i.appendChild(n),t&&t.urlAdmin){const o=document.createElement("button");o.className="sup-5th-btn",o.title=h?"Перейти на сайт":"Перейти в админку",o.innerHTML=h?`
    <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M16 29.3333C23.3637 29.3333 29.3333 23.3637 29.3333 16C29.3333 8.63619 23.3637 2.66666 16 2.66666C8.63616 2.66666 2.66663 8.63619 2.66663 16C2.66663 23.3637 8.63616 29.3333 16 29.3333Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
      <g opacity="0.4">
      <path d="M10.6661 4H11.9994C9.39944 11.7867 9.39944 20.2133 11.9994 28H10.6661" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
      <path d="M20 4C22.6 11.7867 22.6 20.2133 20 28" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
      <path d="M4 21.3333V20C11.7867 22.6 20.2133 22.6 28 20V21.3333" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
      <path d="M4 12.0001C11.7867 9.40014 20.2133 9.40014 28 12.0001" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
      </g>
    </svg>
    `:`
    <svg xmlns="http://www.w3.org/2000/svg" width="0" viewBox="0 0 32 32" fill="none">
      <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M29.333 16C29.333 8.64 23.36 2.667 16 2.667S2.667 8.64 2.667 16 8.64 29.333 16 29.333"/>
      <g stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" opacity=".4">
        <path d="M10.666 4H12a37.899 37.899 0 0 0 0 24h-1.333M20 4a38.074 38.074 0 0 1 1.947 12"/>
        <path d="M4 21.333V20a38.074 38.074 0 0 0 12 1.947M4 12a37.899 37.899 0 0 1 24 0"/>
      </g>
      <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10" stroke-width="1.5" d="m25.615 20.987-4.72 4.72c-.187.186-.36.533-.4.786l-.254 1.8c-.093.654.36 1.107 1.014 1.014l1.8-.254c.253-.04.613-.213.786-.4l4.72-4.72c.814-.813 1.2-1.76 0-2.96-1.186-1.186-2.133-.8-2.946.014Z"/>
      <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10" stroke-width="1.5" d="M24.932 21.667c.4 1.44 1.52 2.56 2.96 2.96"/>
    </svg>
    `,o.addEventListener("mousedown",a=>{if(!t||!(a.buttons===1||a.buttons===4))return;const l=a.buttons===1?"_self":"_blank";h?window.open("/",l):M(l)}),i.appendChild(o)}if(t&&t.manual){const o=document.createElement("a");o.target="_blank",o.className="sup-5th-btn",o.title="Инструкция",o.href="https://"+t.manual,o.innerHTML=`
    <svg xmlns="http://www.w3.org/2000/svg" width="0" viewBox="0 0 32 32" fill="none">
      <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M29.333 22.32V6.227c0-1.6-1.306-2.787-2.893-2.653h-.08c-2.8.24-7.053 1.666-9.427 3.16l-.226.146c-.387.24-1.027.24-1.414 0l-.333-.2C12.587 5.2 8.347 3.787 5.547 3.56c-1.587-.133-2.88 1.067-2.88 2.654V22.32c0 1.28 1.04 2.48 2.32 2.64l.386.054c2.894.386 7.36 1.853 9.92 3.253l.054.027c.36.2.933.2 1.28 0 2.56-1.414 7.04-2.894 9.946-3.28l.44-.054c1.28-.16 2.32-1.36 2.32-2.64Z"/>
      <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 7.32v20m-5.667-16h-3m4 4h-4" opacity=".4"/>
    </svg>
    `,i.appendChild(o)}if(t&&t.addDocument){const o=document.createElement("a");o.target="_blank",o.className="sup-5th-btn",o.title="Доп документ",o.href="https://"+t.addDocument,o.innerHTML=`
    <svg xmlns="http://www.w3.org/2000/svg" width="0" viewBox="0 0 32 32" fill="none">
      <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10" stroke-width="1.5" d="M28 9.333v13.334c0 4-2 6.666-6.667 6.666H10.667C6 29.333 4 26.667 4 22.667V9.333c0-4 2-6.666 6.667-6.666h10.666C26 2.667 28 5.333 28 9.333Z"/>
      <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10" stroke-width="1.5" d="M19.333 6v2.667c0 1.466 1.2 2.666 2.667 2.666h2.667m-14 6H16m-5.333 5.334h10.666" opacity=".4"/>
    </svg>
    `,i.appendChild(o)}const s=(t==null?void 0:t.widgetPosition)||{x:0,y:0};i.style.setProperty("--x",`${s.x}dvw`),i.style.setProperty("--y",`${s.y}dvh`),i.style.setProperty("flex-direction",`${s.x>-50?"row-reverse":"row"}`),A(i),document.body.appendChild(i),i.style.setProperty("--width-full",`${i.childElementCount*68}px`)},A=e=>{let n=!1,s=!1,o=0,a=0,l=0,u=0;const c=()=>{const r=window.getComputedStyle(e);return{x:parseInt(r.getPropertyValue("--x")),y:parseInt(r.getPropertyValue("--y"))}};e.addEventListener("mousedown",r=>{if(r.buttons!==1)return;s=!0,o=r.pageX,a=r.pageY;const{x:m,y:k}=c();l=r.pageX-m/100*window.innerWidth,u=r.pageY-k/100*window.innerHeight}),document.body.addEventListener("mouseup",async()=>{n=!1,s=!1,e.classList.remove("dragging"),t&&(t.widgetPosition=c(),await C())}),document.body.addEventListener("mousemove",r=>{if(s&&(Math.abs(o-r.pageX)>2||Math.abs(a-r.pageY)>2)&&(s=!1,n=!0,e.classList.add("dragging")),!n)return;const m=p((l-r.pageX)*-100/window.innerWidth,{min:-99,max:0});e.style.setProperty("--x",`${m}dvw`),e.style.setProperty("--y",`${p((u-r.pageY)*-100/window.innerHeight,{min:-99,max:0})}dvh`),e.style.setProperty("flex-direction",`${m>-50?"row-reverse":"row"}`)})};E();
